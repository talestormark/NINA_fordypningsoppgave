\documentclass[border=8pt, multi, tikz]{standalone}
\usepackage{import}
\usepackage{xcolor}
\usepackage{amssymb}
\subimport{layers/}{init}
\usetikzlibrary{positioning}
\usetikzlibrary{3d}
\usetikzlibrary{calc}
\usetikzlibrary{decorations.pathreplacing}
\usetikzlibrary{fit}
\usetikzlibrary{arrows.meta}

\def\ConvColor{rgb:yellow,5;red,2.5;white,5}
\def\ConvReluColor{rgb:yellow,5;red,5;white,5}
\def\PoolColor{rgb:red,1;black,0.3}
\def\UnpoolColor{rgb:blue,2;green,1;black,0.3}
\def\LSTMColor{rgb:green,5;blue,3;black,2}
\def\AggColor{rgb:orange,5;red,2;black,1}
\def\LogitsColor{rgb:magenta,5;black,7}
\def\InputColor{rgb:green,3;cyan,2;white,3}

\newcommand{\copymidarrow}{\tikz \draw[-Stealth,line width=0.8mm,draw={rgb:blue,4;red,1;green,1;black,3}] (-0.3,0) -- ++(0.3,0);}

\begin{document}
\begin{tikzpicture}
\tikzstyle{connection}=[ultra thick,every node/.style={sloped,allow upside down},draw=\edgecolor,opacity=0.7]
\tikzstyle{copyconnection}=[ultra thick,every node/.style={sloped,allow upside down},draw={rgb:blue,4;red,1;green,1;black,3},opacity=0.7]
\tikzstyle{temporal}=[ultra thick,every node/.style={sloped,allow upside down},draw={rgb:green,4;blue,2;black,2},opacity=0.7,dashed]
\tikzstyle{recurrent}=[-{Stealth[length=2mm]},thick,draw={rgb:green,5;blue,3;black,2},opacity=0.8]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Input: Multi-temporal Sentinel-2 sequence (T timesteps)
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Stacked temporal inputs
\pic[shift={(-4.5,1.5,0)}] at (0,0,0) {RightBandedBox={name=in1,fill=\InputColor,bandfill=\InputColor,opacity=0.3,height=20,width=1,depth=20}};
\pic[shift={(-4.5,0.7,0.25)}] at (0,0,0) {RightBandedBox={name=in2,fill=\InputColor,bandfill=\InputColor,opacity=0.4,height=20,width=1,depth=20}};
\pic[shift={(-4.5,-0.1,0.5)}] at (0,0,0) {RightBandedBox={name=in3,fill=\InputColor,bandfill=\InputColor,opacity=0.5,height=20,width=1,depth=20}};
\node at (-4.5,-0.9,0) {$\vdots$};
\pic[shift={(-4.5,-1.8,1.0)}] at (0,0,0) {RightBandedBox={name=in7,fill=\InputColor,bandfill=\InputColor,opacity=0.9,height=20,width=1,depth=20}};

\node[above=0.2cm of in1-north, font=\small, align=center] {Input\\(B, T, 9, H, W)};
\node[below=0.15cm of in7-south, font=\tiny] {T$\times$9 bands};

% Year labels
\node[left=0.15cm of in1-west, font=\tiny] {$t_1$};
\node[left=0.15cm of in2-west, font=\tiny] {$t_2$};
\node[left=0.15cm of in3-west, font=\tiny] {$t_3$};
\node[left=0.15cm of in7-west, font=\tiny] {$t_T$};

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Reshape annotation: (B,T,C,H,W) -> (B*T,C,H,W)
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\node[font=\tiny, align=center] at (-2.2,0) {Reshape\\$(B{\cdot}T, 9, H, W)$};

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Shared Encoder (ResNet-50) - processes each timestep with shared weights
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Stage 1: Conv1 -> H/2
\pic[shift={(0,0,0)}] at (0,0,0) {RightBandedBox={name=cr1,caption=Conv1,%
        xlabel={{"64"}},zlabel=H/2,fill=\ConvColor,bandfill=\ConvReluColor,%
        height=26,width={1.8},depth=26}};

% Stage 2: Layer1 -> H/4
\pic[shift={(1.0,0,0)}] at (cr1-east) {RightBandedBox={name=cr2,caption=Layer1,%
        xlabel={{"256"}},zlabel=H/4,fill=\ConvColor,bandfill=\ConvReluColor,%
        height=22,width={2.2},depth=22}};

% Stage 3: Layer2 -> H/8
\pic[shift={(1.0,0,0)}] at (cr2-east) {RightBandedBox={name=cr3,caption=Layer2,%
        xlabel={{"512"}},zlabel=H/8,fill=\ConvColor,bandfill=\ConvReluColor,%
        height=17,width={2.6},depth=17}};

% Stage 4: Layer3 -> H/16
\pic[shift={(1.0,0,0)}] at (cr3-east) {RightBandedBox={name=cr4,caption=Layer3,%
        xlabel={{"1024"}},zlabel=H/16,fill=\ConvColor,bandfill=\ConvReluColor,%
        height=11,width={3.2},depth=11}};

% Stage 5: Layer4 (Bottleneck) -> H/32
\pic[shift={(0.7,0,0)}] at (cr4-east) {RightBandedBox={name=cr5,caption=Layer4,%
        xlabel={{"2048"}},zlabel=H/32,fill=\ConvColor,bandfill=\ConvReluColor,%
        height=5,width={4},depth=5}};

% Shared weights annotation
\node[font=\small, align=center, text=orange] at (4,4.5) {Shared ResNet-50 Encoder};
\node[font=\tiny, align=center, text=orange!70!black] at (4,3.8) {(weights shared across all T timesteps)};

% Encoder bounding box (dashed)
\draw[dashed, orange!50!black, thick, rounded corners=3pt]
    (-0.8,-3.2) rectangle (9.5,3.2);

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% ConvLSTM Module - Temporal Unrolling Visualization
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Show temporal unrolling: bottleneck features at each timestep fed into LSTM cells

% Bottleneck features for each timestep (stacked, coming from encoder)
\pic[shift={(11.5,2.2,0)}] at (0,0,0) {RightBandedBox={name=bt1,fill=\ConvColor,bandfill=\ConvReluColor,opacity=0.4,height=4,width=2,depth=4}};
\pic[shift={(11.5,1.1,0)}] at (0,0,0) {RightBandedBox={name=bt2,fill=\ConvColor,bandfill=\ConvReluColor,opacity=0.5,height=4,width=2,depth=4}};
\pic[shift={(11.5,0,0)}] at (0,0,0) {RightBandedBox={name=bt3,fill=\ConvColor,bandfill=\ConvReluColor,opacity=0.6,height=4,width=2,depth=4}};
\node at (11.5,-0.8,0) {$\vdots$};
\pic[shift={(11.5,-1.6,0)}] at (0,0,0) {RightBandedBox={name=btT,fill=\ConvColor,bandfill=\ConvReluColor,opacity=0.9,height=4,width=2,depth=4}};

\node[left=0.1cm of bt1-west, font=\tiny] {$f_{t_1}$};
\node[left=0.1cm of bt2-west, font=\tiny] {$f_{t_2}$};
\node[left=0.1cm of bt3-west, font=\tiny] {$f_{t_3}$};
\node[left=0.1cm of btT-west, font=\tiny] {$f_{t_T}$};

\node[above=0.1cm of bt1-north, font=\tiny, align=center] {Bottleneck\\(2048, H/32)};

% ConvLSTM Cells - Layer 1 (unrolled over time)
\pic[shift={(14.5,2.2,0)}] at (0,0,0) {RightBandedBox={name=lstm1_t1,fill=\LSTMColor,bandfill=\LSTMColor,opacity=0.5,height=4,width=2.5,depth=4}};
\pic[shift={(14.5,1.1,0)}] at (0,0,0) {RightBandedBox={name=lstm1_t2,fill=\LSTMColor,bandfill=\LSTMColor,opacity=0.6,height=4,width=2.5,depth=4}};
\pic[shift={(14.5,0,0)}] at (0,0,0) {RightBandedBox={name=lstm1_t3,fill=\LSTMColor,bandfill=\LSTMColor,opacity=0.7,height=4,width=2.5,depth=4}};
\node at (14.5,-0.8,0) {$\vdots$};
\pic[shift={(14.5,-1.6,0)}] at (0,0,0) {RightBandedBox={name=lstm1_tT,fill=\LSTMColor,bandfill=\LSTMColor,opacity=0.9,height=4,width=2.5,depth=4}};

\node[above=0.1cm of lstm1_t1-north, font=\tiny, align=center] {ConvLSTM\\Layer 1};

% ConvLSTM Cells - Layer 2 (unrolled over time)
\pic[shift={(17.5,2.2,0)}] at (0,0,0) {RightBandedBox={name=lstm2_t1,fill=\LSTMColor,bandfill=\LSTMColor,opacity=0.5,height=4,width=2.5,depth=4}};
\pic[shift={(17.5,1.1,0)}] at (0,0,0) {RightBandedBox={name=lstm2_t2,fill=\LSTMColor,bandfill=\LSTMColor,opacity=0.6,height=4,width=2.5,depth=4}};
\pic[shift={(17.5,0,0)}] at (0,0,0) {RightBandedBox={name=lstm2_t3,fill=\LSTMColor,bandfill=\LSTMColor,opacity=0.7,height=4,width=2.5,depth=4}};
\node at (17.5,-0.8,0) {$\vdots$};
\pic[shift={(17.5,-1.6,0)}] at (0,0,0) {RightBandedBox={name=lstm2_tT,fill=\LSTMColor,bandfill=\LSTMColor,opacity=0.9,height=4,width=2.5,depth=4}};

\node[above=0.1cm of lstm2_t1-north, font=\tiny, align=center] {ConvLSTM\\Layer 2};

% Output: final hidden state h_T
\pic[shift={(20.5,-1.6,0)}] at (0,0,0) {RightBandedBox={name=hT,fill=\LSTMColor,bandfill=\LSTMColor,opacity=1.0,height=4,width=2,depth=4}};
\node[below=0.1cm of hT-south, font=\tiny, align=center] {$h_T$\\(512, H/32)};

% Connections: bottleneck to LSTM layer 1
\draw [connection] (bt1-east) -- (lstm1_t1-west);
\draw [connection] (bt2-east) -- (lstm1_t2-west);
\draw [connection] (bt3-east) -- (lstm1_t3-west);
\draw [connection] (btT-east) -- (lstm1_tT-west);

% Connections: LSTM layer 1 to layer 2
\draw [connection] (lstm1_t1-east) -- (lstm2_t1-west);
\draw [connection] (lstm1_t2-east) -- (lstm2_t2-west);
\draw [connection] (lstm1_t3-east) -- (lstm2_t3-west);
\draw [connection] (lstm1_tT-east) -- (lstm2_tT-west);

% Recurrent connections (vertical arrows showing temporal flow)
\draw [recurrent] (lstm1_t1-south) -- (lstm1_t2-north);
\draw [recurrent] (lstm1_t2-south) -- (lstm1_t3-north);
\draw [recurrent] (lstm1_tT-north) ++(0,0.3) -- ++(0,-0.3);

\draw [recurrent] (lstm2_t1-south) -- (lstm2_t2-north);
\draw [recurrent] (lstm2_t2-south) -- (lstm2_t3-north);
\draw [recurrent] (lstm2_tT-north) ++(0,0.3) -- ++(0,-0.3);

% Final output connection
\draw [connection] (lstm2_tT-east) -- (hT-west);

% Recurrent state labels
\node[right=0.05cm of lstm1_t1-south, font=\tiny, text=green!50!black] {$h,c$};
\node[right=0.05cm of lstm2_t1-south, font=\tiny, text=green!50!black] {$h,c$};

% ConvLSTM bounding box
\draw[dashed, green!50!black, thick, rounded corners=3pt]
    (13.5,-2.8) rectangle (19.2,3.5);
\node[font=\scriptsize, text=green!50!black, anchor=north west] at (13.6,3.4) {2-Layer ConvLSTM (Temporal Fusion)};
\node[font=\tiny, text=green!50!black, anchor=south west] at (13.6,-2.7) {kernel 3$\times$3, hidden=512};

% Connection from encoder to ConvLSTM input
\draw [connection] (cr5-east) -- ++(1,0) -- ++(0,0) node[midway, above, font=\tiny] {$(B{\cdot}T, 2048)$} -- (10.5,0) -- (bt3-west);

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Skip Connection Aggregation (Max pooling over time) - 5 stages
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Aggregation for stages 1-4 (skip connections)
\pic[shift={(0,2.8,0)}] at (cr4-east) {Ball={name=agg4, fill=\AggColor, opacity=0.6, radius=1.8,
         logo={\scalebox{0.15}{\textbf{max}}}}};
\pic[shift={(0,2.8,0)}] at (cr3-east) {Ball={name=agg3, fill=\AggColor, opacity=0.6, radius=1.8,
         logo={\scalebox{0.15}{\textbf{max}}}}};
\pic[shift={(0,2.8,0)}] at (cr2-east) {Ball={name=agg2, fill=\AggColor, opacity=0.6, radius=1.8,
         logo={\scalebox{0.15}{\textbf{max}}}}};
\pic[shift={(0,2.8,0)}] at (cr1-east) {Ball={name=agg1, fill=\AggColor, opacity=0.6, radius=1.8,
         logo={\scalebox{0.15}{\textbf{max}}}}};

% Stage 0 aggregation (input level)
\pic[shift={(-0.5,2.8,0)}] at (cr1-west) {Ball={name=agg0, fill=\AggColor, opacity=0.6, radius=1.8,
         logo={\scalebox{0.15}{\textbf{max}}}}};

\node[above=0.05cm of agg2-north, font=\tiny, align=center] {Max pool over T};

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Decoder (U-Net upsampling path) - 5 blocks
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Decoder block 5: H/32 -> H/16 (from LSTM output)
\pic[shift={(22.5,-1.6,0)}] at (0,0,0) {Box={name=up5,%
        fill=\UnpoolColor,opacity=0.6,height=11,width=0.8,depth=11}};
\pic[shift={(0,0,0)}] at (up5-east) {RightBandedBox={name=ucr5,%
        xlabel={{"256"}},fill=\ConvColor,bandfill=\ConvReluColor,%
        height=11,width=2.5,depth=11}};
\pic[shift={(0,0,0)}] at (ucr5-east) {RightBandedBox={name=cat5,%
        fill={rgb:white,1;black,3},bandfill={rgb:white,1;black,2},opacity=0.3,%
        height=11,width=2.5,depth=11}};
\pic[shift={(0,0,0)}] at (cat5-east) {RightBandedBox={name=ucr5a,%
        zlabel=H/16,fill=\ConvColor,bandfill=\ConvReluColor,%
        height=11,width=2.5,depth=11}};

% Decoder block 4: H/16 -> H/8
\pic[shift={(0.5,0,0)}] at (ucr5a-east) {Box={name=up4,%
        fill=\UnpoolColor,opacity=0.6,height=17,width=0.8,depth=17}};
\pic[shift={(0,0,0)}] at (up4-east) {RightBandedBox={name=ucr4,%
        xlabel={{"128"}},fill=\ConvColor,bandfill=\ConvReluColor,%
        height=17,width=2,depth=17}};
\pic[shift={(0,0,0)}] at (ucr4-east) {RightBandedBox={name=cat4,%
        fill={rgb:white,1;black,3},bandfill={rgb:white,1;black,2},opacity=0.3,%
        height=17,width=2,depth=17}};
\pic[shift={(0,0,0)}] at (cat4-east) {RightBandedBox={name=ucr4a,%
        zlabel=H/8,fill=\ConvColor,bandfill=\ConvReluColor,%
        height=17,width=2,depth=17}};

% Decoder block 3: H/8 -> H/4
\pic[shift={(0.5,0,0)}] at (ucr4a-east) {Box={name=up3,%
        fill=\UnpoolColor,opacity=0.6,height=22,width=0.8,depth=22}};
\pic[shift={(0,0,0)}] at (up3-east) {RightBandedBox={name=ucr3,%
        xlabel={{"64"}},fill=\ConvColor,bandfill=\ConvReluColor,%
        height=22,width=1.6,depth=22}};
\pic[shift={(0,0,0)}] at (ucr3-east) {RightBandedBox={name=cat3,%
        fill={rgb:white,1;black,3},bandfill={rgb:white,1;black,2},opacity=0.3,%
        height=22,width=1.6,depth=22}};
\pic[shift={(0,0,0)}] at (cat3-east) {RightBandedBox={name=ucr3a,%
        zlabel=H/4,fill=\ConvColor,bandfill=\ConvReluColor,%
        height=22,width=1.6,depth=22}};

% Decoder block 2: H/4 -> H/2
\pic[shift={(0.5,0,0)}] at (ucr3a-east) {Box={name=up2,%
        fill=\UnpoolColor,opacity=0.6,height=26,width=0.8,depth=26}};
\pic[shift={(0,0,0)}] at (up2-east) {RightBandedBox={name=ucr2,%
        xlabel={{"32"}},fill=\ConvColor,bandfill=\ConvReluColor,%
        height=26,width=1.3,depth=26}};
\pic[shift={(0,0,0)}] at (ucr2-east) {RightBandedBox={name=cat2,%
        fill={rgb:white,1;black,3},bandfill={rgb:white,1;black,2},opacity=0.3,%
        height=26,width=1.3,depth=26}};
\pic[shift={(0,0,0)}] at (cat2-east) {RightBandedBox={name=ucr2a,%
        zlabel=H/2,fill=\ConvColor,bandfill=\ConvReluColor,%
        height=26,width=1.3,depth=26}};

% Decoder block 1: H/2 -> H
\pic[shift={(0.5,0,0)}] at (ucr2a-east) {Box={name=up1,%
        fill=\UnpoolColor,opacity=0.6,height=30,width=0.8,depth=30}};
\pic[shift={(0,0,0)}] at (up1-east) {RightBandedBox={name=ucr1,%
        xlabel={{"16"}},fill=\ConvColor,bandfill=\ConvReluColor,%
        height=30,width=1.1,depth=30}};
\pic[shift={(0,0,0)}] at (ucr1-east) {RightBandedBox={name=cat1,%
        fill={rgb:white,1;black,3},bandfill={rgb:white,1;black,2},opacity=0.3,%
        height=30,width=1.1,depth=30}};
\pic[shift={(0,0,0)}] at (cat1-east) {RightBandedBox={name=ucr1a,%
        zlabel=H,fill=\ConvColor,bandfill=\ConvReluColor,%
        height=30,width=1.1,depth=30}};

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Output Head: 1x1 Conv
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\pic[shift={(0.4,0,0)}] at (ucr1a-east) {Box={name=out,caption=1x1,%
        zlabel=H$\times$W,fill=\LogitsColor,height=30,width=1,depth=30}};

\node[below=0.2cm of out-south, font=\scriptsize, align=center] {Output\\(B, 1, H, W)};

% Decoder label
\node[font=\small, align=center, text=blue!60!green] at (32,4.5) {U-Net Decoder};

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Connections: Input to Encoder
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\draw [connection]  (in7-east) -- (cr1-west);

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Connections: Encoder forward path
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\draw [connection]  (cr1-east) -- node {\midarrow} (cr2-west);
\draw [connection]  (cr2-east) -- node {\midarrow} (cr3-west);
\draw [connection]  (cr3-east) -- node {\midarrow} (cr4-west);
\draw [connection]  (cr4-east) -- node {\midarrow} (cr5-west);

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Connections: ConvLSTM to Decoder
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\draw [connection]  (hT-east) -- (up5-west);

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Connections: Decoder forward path
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\draw [connection]  (ucr5a-east) -- node {\midarrow} (up4-west);
\draw [connection]  (ucr4a-east) -- node {\midarrow} (up3-west);
\draw [connection]  (ucr3a-east) -- node {\midarrow} (up2-west);
\draw [connection]  (ucr2a-east) -- node {\midarrow} (up1-west);
\draw [connection]  (ucr1a-east) -- node {\midarrow} (out-west);

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Skip Connections: Encoder to Aggregation (temporal features)
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\draw [temporal] (cr4-north) -- (agg4-south);
\draw [temporal] (cr3-north) -- (agg3-south);
\draw [temporal] (cr2-north) -- (agg2-south);
\draw [temporal] (cr1-north) -- (agg1-south);
\draw [temporal] (cr1-west) ++(-0.3,1.3) -- (agg0-south);

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Skip Connections: Aggregation to Decoder
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\path (cat5-south) -- (cat5-north) coordinate[pos=1.6] (cat5_top);
\path (cat4-south) -- (cat4-north) coordinate[pos=1.4] (cat4_top);
\path (cat3-south) -- (cat3-north) coordinate[pos=1.3] (cat3_top);
\path (cat2-south) -- (cat2-north) coordinate[pos=1.25] (cat2_top);
\path (cat1-south) -- (cat1-north) coordinate[pos=1.2] (cat1_top);

\draw [copyconnection]  (agg4-east)
    -- node {\copymidarrow}(cat5_top)
    -- node {\copymidarrow} (cat5-north);

\draw [copyconnection]  (agg3-east)
    -- node {\copymidarrow}(cat4_top)
    -- node {\copymidarrow} (cat4-north);

\draw [copyconnection]  (agg2-east)
    -- node {\copymidarrow}(cat3_top)
    -- node {\copymidarrow} (cat3-north);

\draw [copyconnection]  (agg1-east)
    -- node {\copymidarrow}(cat2_top)
    -- node {\copymidarrow} (cat2-north);

\draw [copyconnection]  (agg0-east)
    -- node {\copymidarrow}(cat1_top)
    -- node {\copymidarrow} (cat1-north);

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Legend
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\node[font=\tiny, align=left, anchor=north west] at (-5,-4.2) {
    \textcolor{orange!80!black}{$\blacksquare$} Conv + BN + ReLU\\[1pt]
    \textcolor{blue!60!green}{$\blacksquare$} Upsample\\[1pt]
    \textcolor{green!50!black}{$\blacksquare$} ConvLSTM Cell\\[1pt]
    \textcolor{orange!70!red}{$\bullet$} Temporal Max Pool\\[1pt]
    \textcolor{gray}{$\blacksquare$} Skip Concat\\[1pt]
    \textcolor{magenta!70!black}{$\blacksquare$} Seg. Head\\[1pt]
    \textcolor{green!50!black}{$\downarrow$} Recurrent $(h,c)$
};

\end{tikzpicture}
\end{document}
